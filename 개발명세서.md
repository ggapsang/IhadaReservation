# 예약 관리 시스템 개발 명세서

## 1. 시스템 개요

Google Apps Script를 활용한 실시간 예약 관리 시스템으로, WebApp 형태로 구현되어 Google Site에 임베드됩니다.

### 1.1 기술 스택
- **Backend**: Google Apps Script
- **Database**: Google Spreadsheet
- **UI**: HTML/CSS/JavaScript
- **External APIs**: Kakao Talk API, Google Calendar API

---

## 2. Google Spreadsheet 구조

### 2.1 시트 구성

#### Sheet 1: `예약내역`
예약 신청 정보를 저장하는 메인 시트

| 컬럼명 | 데이터 타입 | 설명 | 비고 |
|--------|------------|------|------|
| A: 예약번호 | Text | 자동생성 ID (예: RES20250101-001) | Primary Key |
| B: 신청일시 | DateTime | 예약 신청 시각 | 자동생성 |
| C: 예약날짜 | Date | 방문 예약 날짜 | 필수 |
| D: 시작시간 | Time | 입실 시간 (30분 단위) | 필수 |
| E: 종료시간 | Time | 퇴실 시간 (30분 단위) | 필수 |
| F: 이용시간 | Number | 총 이용 시간(시간) | 자동계산 |
| G: Room타입 | Text | A, B, C, D 또는 A+B | 필수 |
| H: 업체명 | Text | 업체 및 브랜드명 | 필수 |
| I: 인스타그램ID | Text | @ 포함 | 선택 |
| J: 이름 | Text | 예약자 이름 | 필수 |
| K: 연락처 | Text | 휴대폰 번호 (010-0000-0000) | 필수 |
| L: 전체인원 | Number | 방문 인원 수 | 필수 |
| M: 차량대수 | Number | 방문 차량 대수 | 필수 |
| N: 세금계산서 | Boolean | Y/N | 필수 |
| O: 유입경로 | Text | 네이버/인스타그램/지인소개/공간플랫폼/기타 | 필수 |
| P: 촬영내용 | Text | 의류/광고/드라마/잡지/스냅/기타 | 필수 |
| Q: 기본요금 | Number | 룸 기본 요금 | 자동계산 |
| R: 추가인원요금 | Number | 초과 인원 요금 | 자동계산 |
| S: 소계 | Number | 기본+추가 요금 | 자동계산 |
| T: VAT | Number | 부가세 (10%) | 자동계산 |
| U: 총금액 | Number | 최종 결제 금액 | 자동계산 |
| V: 입금확인 | Boolean | Y/N | 관리자 입력 |
| W: 입금확인일시 | DateTime | 입금 확인 시각 | 자동생성 |
| X: 사업자등록증 | URL | Drive 파일 링크 | 선택 |
| Y: Calendar이벤트ID | Text | Google Calendar Event ID | 자동생성 |
| Z: 알림톡발송상태 | Text | 확정완료/입실대기/퇴실대기 | 자동업데이트 |
| AA: 비고 | Text | 관리자 메모 | 선택 |

#### Sheet 2: `설정`
시스템 운영 정책 및 설정값 관리

| 항목명 | 값 | 단위 | 설명 |
|--------|-----|------|------|
| 기준인원 | 3 | 명 | 룸당 기본 인원 |
| 시간당기본요금 | 44000 | 원 | 시간당 기본 요금 |
| 최소이용시간 | 2 | 시간 | 최소 예약 시간 |
| 추가인원단가 | 5000 | 원/인 | 1인당 추가 요금 |
| AB동시대관기준 | 10 | 명 | A+B 자동 선택 기준 |
| VAT요율 | 10 | % | 부가세율 |
| 운영시작시간 | 09:00 | 시:분 | 일일 운영 시작 |
| 운영종료시간 | 22:00 | 시:분 | 일일 운영 종료 |
| 예약시간단위 | 30 | 분 | 예약 가능 시간 단위 |

#### Sheet 3: `Room정보`
각 룸별 상세 정보

| Room타입 | 수용인원 | 시간당요금 | 설명 | 활성화 |
|----------|----------|-----------|------|--------|
| A | 8 | 44000 | 메인 스튜디오 A | Y |
| B | 8 | 44000 | 메인 스튜디오 B | Y |
| C | 5 | 44000 | 소형 스튜디오 C | Y |
| D | 5 | 44000 | 소형 스튜디오 D | Y |
| A+B | 16 | 88000 | A+B 동시 대관 | Y |

#### Sheet 4: `알림톡템플릿`
카카오 알림톡 메시지 템플릿

| 템플릿명 | 템플릿코드 | 발송시점 | 메시지내용 |
|----------|-----------|----------|-----------|
| 예약확정 | CONFIRM_001 | 입금확인 즉시 | (템플릿 내용) |
| 입실안내 | CHECKIN_001 | 예약 30분 전 | (템플릿 내용) |
| 퇴실안내 | CHECKOUT_001 | 퇴실 30분 전 | (템플릿 내용) |

#### Sheet 5: `예약현황로그`
실시간 예약 조회 로그 (디버깅/통계용)

| 조회일시 | Room타입 | 예약날짜 | 시작시간 | 종료시간 | 가능여부 |
|---------|---------|---------|---------|---------|---------|

---

## 3. 주요 함수 명세

### 3.1 WebApp 진입점 함수

#### `doGet(e)`
```javascript
/**
 * WebApp 진입점 - HTML 페이지 렌더링
 * @param {Object} e - 요청 파라미터 객체
 * @return {HtmlOutput} HTML 페이지
 */
```
**기능**:
- index.html 파일을 로드하여 WebApp UI 반환
- CORS 헤더 설정

#### `doPost(e)`
```javascript
/**
 * POST 요청 처리
 * @param {Object} e - 요청 파라미터 객체
 * @return {ContentService} JSON 응답
 */
```
**기능**:
- 예약 제출 요청 처리
- 파일 업로드 처리

---

### 3.2 설정 관리 함수

#### `getSettings()`
```javascript
/**
 * 설정 시트에서 정책 값 읽기
 * @return {Object} 설정 객체
 * {
 *   basePersons: 3,
 *   baseRate: 44000,
 *   minHours: 2,
 *   extraPersonRate: 5000,
 *   abThreshold: 10,
 *   vatRate: 10
 * }
 */
```

#### `getRoomInfo()`
```javascript
/**
 * Room 정보 시트에서 활성화된 룸 정보 조회
 * @return {Array} Room 객체 배열
 * [{
 *   type: 'A',
 *   capacity: 8,
 *   rate: 44000,
 *   description: '...',
 *   active: true
 * }]
 */
```

#### `updateSettings(key, value)`
```javascript
/**
 * 설정 값 업데이트
 * @param {string} key - 설정 항목명
 * @param {any} value - 새로운 값
 * @return {boolean} 성공 여부
 */
```

---

### 3.3 가격 계산 함수

#### `calculatePrice(persons, hours, roomType)`
```javascript
/**
 * 예약 금액 실시간 계산
 * @param {number} persons - 전체 인원
 * @param {number} hours - 이용 시간
 * @param {string} roomType - Room 타입
 * @return {Object} 가격 상세 객체
 * {
 *   basePrice: 88000,        // 기본 요금
 *   extraPersonFee: 10000,   // 추가 인원 요금
 *   subtotal: 98000,         // 소계
 *   vat: 9800,               // 부가세
 *   total: 107800            // 총 금액
 * }
 */
```
**로직**:
1. 설정값 로드 (`getSettings()`)
2. 기본요금 = 시간당요금 × 이용시간
3. 초과인원 = Math.max(0, 인원 - 기준인원)
4. 추가요금 = 초과인원 × 추가인원단가 × 이용시간
5. 소계 = 기본요금 + 추가요금
6. VAT = 소계 × VAT요율
7. 총금액 = 소계 + VAT

#### `suggestRoomType(persons)`
```javascript
/**
 * 인원에 따른 Room 타입 자동 추천
 * @param {number} persons - 전체 인원
 * @return {string} 추천 Room 타입
 */
```
**로직**:
- 10명 이상 → "A+B"
- 10명 미만 → "A" (기본값, 사용자가 선택 가능)

---

### 3.4 예약 가능 여부 확인 함수

#### `checkAvailability(date, startTime, endTime, roomType)`
```javascript
/**
 * 특정 날짜/시간/룸의 예약 가능 여부 확인
 * @param {string} date - 예약 날짜 (YYYY-MM-DD)
 * @param {string} startTime - 시작 시간 (HH:MM)
 * @param {string} endTime - 종료 시간 (HH:MM)
 * @param {string} roomType - Room 타입
 * @return {Object}
 * {
 *   available: true/false,
 *   conflictReservations: [] // 중복되는 예약 목록
 * }
 */
```
**로직**:
1. `예약내역` 시트에서 해당 날짜 + Room 조회
2. 시간 겹침 검사 (입금확인=Y 건만)
3. A+B 선택 시 A와 B 둘 다 확인
4. 중복 발견 시 `available: false` 반환

#### `getReservationsByDate(date)`
```javascript
/**
 * 특정 날짜의 모든 예약 조회
 * @param {string} date - 조회 날짜 (YYYY-MM-DD)
 * @return {Array} 예약 객체 배열
 */
```

---

### 3.5 예약 등록 함수

#### `submitReservation(formData)`
```javascript
/**
 * 새 예약 등록 (메인 함수)
 * @param {Object} formData - 폼 데이터 객체
 * @return {Object}
 * {
 *   success: true/false,
 *   reservationNumber: 'RES20250101-001',
 *   message: '예약이 완료되었습니다.',
 *   error: null
 * }
 */
```
**프로세스**:
1. 데이터 유효성 검증 (`validateFormData()`)
2. 예약 가능 여부 확인 (`checkAvailability()`)
3. 가격 계산 (`calculatePrice()`)
4. 예약번호 생성 (`generateReservationNumber()`)
5. 사업자등록증 업로드 처리 (`uploadFile()`)
6. `예약내역` 시트에 데이터 추가
7. 에러 발생 시 롤백

#### `generateReservationNumber()`
```javascript
/**
 * 고유 예약번호 생성
 * @return {string} 예약번호 (예: RES20250101-001)
 */
```
**형식**: `RES + YYYYMMDD + - + 일련번호(3자리)`

#### `validateFormData(data)`
```javascript
/**
 * 폼 데이터 유효성 검증
 * @param {Object} data - 폼 데이터
 * @return {Object} { valid: true/false, errors: [] }
 */
```
**검증 항목**:
- 필수 필드 존재 여부
- 연락처 형식 (010-XXXX-XXXX)
- 날짜 형식 및 과거 날짜 체크
- 시간 형식 및 논리적 순서
- 인원/차량 양수 체크
- 약관 동의 여부

---

### 3.6 파일 처리 함수

#### `uploadFile(fileBlob, reservationNumber)`
```javascript
/**
 * 사업자등록증 파일을 Google Drive에 업로드
 * @param {Blob} fileBlob - 파일 Blob 객체
 * @param {string} reservationNumber - 예약번호
 * @return {string} 업로드된 파일의 Drive URL
 */
```
**기능**:
- Drive 폴더 자동 생성 (폴더명: "예약_사업자등록증")
- 파일명: `{예약번호}_{원본파일명}`
- 10MB 크기 제한 체크
- 업로드 후 공유 권한 설정 (제한된 접근)

---

### 3.7 입금 확인 및 Calendar 연동

#### `confirmPayment(reservationNumber)`
```javascript
/**
 * 입금 확인 처리 (관리자용)
 * @param {string} reservationNumber - 예약번호
 * @return {Object} { success: true/false, calendarEventId: '...' }
 */
```
**프로세스**:
1. 해당 예약 정보 조회
2. `입금확인` 필드를 Y로 업데이트
3. `입금확인일시` 현재 시각으로 기록
4. Google Calendar 이벤트 생성 (`createCalendarEvent()`)
5. Calendar 이벤트 ID 저장
6. 카카오 알림톡 발송 (`sendKakaoMessage()` - 예약확정)

#### `createCalendarEvent(reservationData)`
```javascript
/**
 * Google Calendar에 예약 이벤트 생성
 * @param {Object} reservationData - 예약 정보 객체
 * @return {string} Calendar Event ID
 */
```
**이벤트 정보**:
- 제목: `[{Room타입}] {업체명} - {촬영내용}`
- 시작: `{예약날짜} {시작시간}`
- 종료: `{예약날짜} {종료시간}`
- 설명: 예약자 정보, 연락처, 인원, 차량, 금액 등
- 알림: 30분 전 팝업

---

### 3.8 카카오 알림톡 함수

#### `sendKakaoMessage(type, phoneNumber, reservationData)`
```javascript
/**
 * 카카오 알림톡 발송
 * @param {string} type - 메시지 타입 (confirm/checkin/checkout)
 * @param {string} phoneNumber - 수신 번호
 * @param {Object} reservationData - 예약 정보
 * @return {Object} { success: true/false, messageId: '...' }
 */
```
**기능**:
1. `알림톡템플릿` 시트에서 템플릿 조회
2. 템플릿 변수 치환 ({{예약번호}}, {{업체명}} 등)
3. Kakao API 호출 (UrlFetchApp 사용)
4. 발송 결과를 `예약내역` 시트 업데이트

#### `scheduleMessages(reservationNumber)`
```javascript
/**
 * 입실/퇴실 알림톡 예약 발송 설정
 * @param {string} reservationNumber - 예약번호
 * @return {void}
 */
```
**기능**:
- Time-driven trigger 생성
- 입실 30분 전: `sendKakaoMessage('checkin', ...)`
- 퇴실 30분 전: `sendKakaoMessage('checkout', ...)`

#### `checkAndSendScheduledMessages()`
```javascript
/**
 * 예약 발송 대기 중인 알림톡 체크 및 발송
 * (Trigger로 1분마다 실행)
 * @return {void}
 */
```
**로직**:
1. 현재 시각 기준 ±5분 이내 발송 대상 조회
2. `입실안내` 발송 대상: 입금확인=Y, 시작시간-30분
3. `퇴실안내` 발송 대상: 입금확인=Y, 종료시간-30분
4. 발송 후 `알림톡발송상태` 업데이트

---

### 3.9 관리자 페이지 함수

#### `getReservationList(filter)`
```javascript
/**
 * 예약 목록 조회 (관리자용)
 * @param {Object} filter - 필터 조건
 * { dateFrom, dateTo, paymentStatus, roomType }
 * @return {Array} 예약 목록 배열
 */
```

#### `updateReservation(reservationNumber, updates)`
```javascript
/**
 * 예약 정보 수정 (관리자용)
 * @param {string} reservationNumber - 예약번호
 * @param {Object} updates - 수정할 필드 객체
 * @return {boolean} 성공 여부
 */
```

#### `cancelReservation(reservationNumber, reason)`
```javascript
/**
 * 예약 취소 처리
 * @param {string} reservationNumber - 예약번호
 * @param {string} reason - 취소 사유
 * @return {boolean} 성공 여부
 */
```
**프로세스**:
1. Calendar 이벤트 삭제
2. 예약 상태를 '취소'로 변경
3. 취소 알림톡 발송 (선택)

---

### 3.10 유틸리티 함수

#### `formatDateTime(date, time)`
```javascript
/**
 * 날짜와 시간을 표준 형식으로 포맷팅
 * @param {string} date - YYYY-MM-DD
 * @param {string} time - HH:MM
 * @return {Date} JavaScript Date 객체
 */
```

#### `formatPhoneNumber(phone)`
```javascript
/**
 * 전화번호 형식 정규화
 * @param {string} phone - 입력 전화번호
 * @return {string} 010-XXXX-XXXX 형식
 */
```

#### `logActivity(action, data)`
```javascript
/**
 * 활동 로그 기록 (디버깅용)
 * @param {string} action - 액션명
 * @param {Object} data - 로그 데이터
 * @return {void}
 */
```

---

## 4. 데이터 흐름

### 4.1 예약 신청 플로우
```
[사용자 입력]
    ↓
[실시간 가격 계산 - calculatePrice()]
    ↓
[제출 버튼 클릭]
    ↓
[유효성 검증 - validateFormData()]
    ↓
[예약 가능 여부 확인 - checkAvailability()]
    ↓ (가능)
[파일 업로드 - uploadFile()]
    ↓
[예약 등록 - submitReservation()]
    ↓
[Spreadsheet 저장]
    ↓
[확인 메시지 표시]
```

### 4.2 입금 확인 플로우
```
[관리자가 입금확인 체크박스 체크]
    ↓
[confirmPayment() 실행]
    ↓
[Google Calendar 이벤트 생성]
    ↓
[예약확정 알림톡 즉시 발송]
    ↓
[입실/퇴실 안내 알림톡 예약 설정]
```

### 4.3 알림톡 발송 플로우
```
[1분마다 Trigger 실행]
    ↓
[checkAndSendScheduledMessages()]
    ↓
[발송 대상 예약 조회]
    ↓ (대상 있음)
[알림톡템플릿 로드]
    ↓
[변수 치환 및 메시지 생성]
    ↓
[Kakao API 호출]
    ↓
[발송 상태 업데이트]
```

---

## 5. API 연동 명세

### 5.1 Kakao Talk API

**Endpoint**: `https://kapi.kakao.com/v1/alimtalk/send`

**Headers**:
```
Authorization: Bearer {ACCESS_TOKEN}
Content-Type: application/json
```

**Request Body** (예약확정):
```json
{
  "template_id": "CONFIRM_001",
  "receiver_phone": "01012345678",
  "message": {
    "예약번호": "RES20250101-001",
    "업체명": "ABC Studio",
    "예약날짜": "2025-01-15",
    "시작시간": "10:00",
    "종료시간": "14:00",
    "Room타입": "A",
    "총금액": "107,800원"
  }
}
```

**Response**:
```json
{
  "message_id": "msg_xxxx",
  "status": "success"
}
```

### 5.2 Google Calendar API

Apps Script의 `CalendarApp` 서비스 사용

**이벤트 생성**:
```javascript
CalendarApp.getDefaultCalendar().createEvent(
  title,
  startTime,
  endTime,
  {
    description: description,
    location: location,
    guests: email,
    sendInvites: false
  }
);
```

---

## 6. UI 구조 (index.html)

### 6.1 섹션 구성

1. **헤더**
   - 로고 및 시스템 제목

2. **예약 정보 입력 섹션**
   - 업체정보 (업체명, 인스타그램ID)
   - 예약자 정보 (이름, 연락처)
   - 방문 정보 (인원, 차량)

3. **날짜/시간 선택 섹션**
   - 날짜 선택 (Datepicker)
   - 시작/종료 시간 (Dropdown, 30분 단위)
   - 이용시간 자동 계산 표시

4. **Room 선택 섹션**
   - Room 타입 Dropdown
   - 인원에 따른 자동 추천 표시

5. **옵션 선택 섹션**
   - 세금계산서 발행 (라디오 버튼)
   - 유입경로 (Dropdown)
   - 촬영내용 (Dropdown)

6. **파일 업로드 섹션**
   - 사업자등록증 업로드 (세금계산서 Y 선택 시 필수)
   - 파일 크기 안내 (10MB 이내)

7. **가격 표시 섹션** (실시간 업데이트)
   - 기본요금
   - 추가인원요금
   - 소계
   - VAT
   - **총 금액** (강조)

8. **약관 동의 섹션**
   - 이용약관 체크박스
   - 약관 내용 모달

9. **제출 버튼**
   - 예약 신청 버튼
   - 로딩 인디케이터

### 6.2 JavaScript 이벤트

- **인원 입력 변경**: Room 타입 자동 추천 + 가격 재계산
- **시간 선택 변경**: 이용시간 계산 + 가격 재계산
- **Room 타입 변경**: 가격 재계산
- **제출 버튼 클릭**:
  1. 클라이언트 측 유효성 검증
  2. 예약 가능 여부 확인 (AJAX)
  3. 폼 데이터 전송 (google.script.run)

---

## 7. 보안 및 에러 처리

### 7.1 보안 고려사항

- WebApp 배포 시 "나만 실행" 설정 (관리자만 스크립트 실행 권한)
- 사용자는 "익명 포함 모든 사용자" 액세스
- 민감 정보 (Kakao API Key) Script Properties에 저장
- 파일 업로드 크기 제한 (10MB)
- XSS 방지: HTML 출력 시 이스케이프 처리

### 7.2 에러 처리

- 모든 주요 함수에 try-catch 블록
- 에러 발생 시 사용자 친화적 메시지 반환
- 시스템 에러는 Logger에 기록
- API 호출 실패 시 재시도 로직 (최대 3회)

### 7.3 데이터 무결성

- 예약 등록 시 트랜잭션 처리 (실패 시 롤백)
- 중복 예약 방지를 위한 Lock 메커니즘
- 데이터 변경 시 변경 이력 로그

---

## 8. 배포 및 설정

### 8.1 초기 설정 단계

1. Google Spreadsheet 생성 및 시트 구조 셋업
2. Google Apps Script 프로젝트 생성
3. Script Properties 설정:
   - `KAKAO_API_KEY`: 카카오 REST API 키
   - `KAKAO_SENDER_KEY`: 알림톡 발신 키
   - `CALENDAR_ID`: Google Calendar ID
4. 외부 API 권한 설정 (UrlFetchApp 허용)
5. Time-driven Trigger 설정:
   - `checkAndSendScheduledMessages()` - 1분마다 실행

### 8.2 WebApp 배포

1. Apps Script 편집기에서 "배포 > 새 배포"
2. 유형: 웹 앱
3. 실행 계정: 나
4. 액세스 권한: 모든 사용자
5. 배포 URL 복사

### 8.3 Google Site 임베드

1. Google Site에서 새 페이지 생성
2. "삽입 > URL 삽입"
3. WebApp 배포 URL 입력
4. iframe 크기 조정 (권장: 800px × 1200px)

---

## 9. 테스트 시나리오

### 9.1 기능 테스트

- [ ] 예약 신청 정상 처리
- [ ] 중복 예약 방지 동작 확인
- [ ] 가격 계산 정확성 검증
- [ ] Room 자동 추천 로직 검증
- [ ] 파일 업로드 및 Drive 저장
- [ ] 입금 확인 시 Calendar 이벤트 생성
- [ ] 알림톡 발송 (예약확정/입실/퇴실)

### 9.2 예외 상황 테스트

- [ ] 필수 입력 누락 시 에러 메시지
- [ ] 과거 날짜 선택 시 에러
- [ ] 종료시간 < 시작시간 에러
- [ ] 최소 이용시간 미달 에러
- [ ] 파일 크기 초과 에러
- [ ] API 호출 실패 시 재시도
- [ ] 동시 예약 신청 시 Lock 처리

---

## 10. 향후 확장 가능성

- 예약자 전용 마이페이지 (예약 조회/취소)
- 관리자 대시보드 (통계, 매출 분석)
- 대기 예약 시스템 (취소 발생 시 자동 안내)
- 이메일 알림 추가 (알림톡 보조)
- 결제 시스템 연동 (토스페이먼츠, PG사)
- 정기 예약 기능
- 할인 쿠폰 시스템

---

## 부록: 코드 파일 구조

```
/Code.gs                    # 메인 백엔드 로직
/Config.gs                  # 설정 관리 함수
/Reservation.gs             # 예약 관련 함수
/Payment.gs                 # 입금/결제 관련 함수
/Calendar.gs                # Google Calendar 연동
/Kakao.gs                   # 카카오 알림톡 함수
/Utils.gs                   # 유틸리티 함수
/Admin.gs                   # 관리자 함수
/index.html                 # WebApp UI
/styles.html                # CSS 스타일시트
/script.html                # 클라이언트 JavaScript
```

---

**문서 버전**: 1.0
**작성일**: 2025-12-04
**작성자**: Claude Code
